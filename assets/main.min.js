/**
 * El San Jose - Main JavaScript
 * Optimized from Carrd-generated code
 * @version 2.0
 */
(function() {
  'use strict';

  // ========================================
  // UTILITIES
  // ========================================
  const $ = (q, p) => (p || document).querySelector(q);
  const $$ = (q, p) => (p || document).querySelectorAll(q);
  const $body = document.body;
  
  const on = (e, h, c) => window.addEventListener(e, h, c);
  const off = (e, h) => window.removeEventListener(e, h);
  const trigger = (e) => window.dispatchEvent(new Event(e));

  const escapeHtml = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  const thisHash = () => window.location.hash.substring(1);

  // ========================================
  // CLIENT DETECTION
  // ========================================
  const client = (() => {
    const ua = navigator.userAgent.toLowerCase();
    const os = /iphone|ipad|ipod/.test(ua) ? 'ios' : /android/.test(ua) ? 'android' : /mac os x/.test(ua) ? 'macos' : /windows/.test(ua) ? 'windows' : 'other';
    const browser = /edge\/|edg\//.test(ua) ? 'edge' : /chrome/.test(ua) ? 'chrome' : /firefox/.test(ua) ? 'firefox' : /safari/.test(ua) ? 'safari' : 'other';
    const mobile = ['ios','android'].includes(os);
    
    let osVersion = 0;
    if (os === 'ios') {
      const m = ua.match(/os (\d+)/);
      if (m) osVersion = parseInt(m[1]);
    } else if (os === 'android') {
      const m = ua.match(/android (\d+)/);
      if (m) osVersion = parseInt(m[1]);
    }
    
    return {
      os, osVersion, browser, mobile,
      flags: { lsdUnits: CSS.supports('width: 100svh') },
      canUse: (p) => p in document.createElement('div').style
    };
  })();

  // ========================================
  // READY QUEUE
  // ========================================
  const ready = {
    queue: [],
    add: function(h) { this.queue.push(h); },
    run: function() { this.queue.forEach(h => h()); }
  };

  // ========================================
  // SCROLL FUNCTIONS
  // ========================================
  const scrollToElement = (el, behavior = 'smooth', duration = 750) => {
    const y = el ? el.getBoundingClientRect().top + window.scrollY : 0;
    if (client.canUse('scrollBehavior')) {
      window.scrollTo({ top: y, behavior });
    } else {
      const start = window.scrollY;
      const startTime = Date.now();
      const scroll = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
        window.scrollTo(0, start + (y - start) * ease);
        if (progress < 1) requestAnimationFrame(scroll);
      };
      scroll();
    }
  };

  window._scrollToTop = () => scrollToElement(null);

  // Load/unload elements
  const loadElements = (parent) => {
    const event = new Event('elementLoaded');
    parent.querySelectorAll('iframe[data-src]:not([data-src=""])').forEach(el => {
      el.dataset.initialSrc = el.dataset.src;
      el.src = el.dataset.src;
      el.dataset.src = '';
      el.removeAttribute('data-unloaded');
      el.dispatchEvent(event);
    });
    parent.querySelectorAll('video[autoplay]').forEach(v => v.play());
  };

  const unloadElements = (parent) => {
    parent.querySelectorAll('iframe[data-src=""]').forEach(el => {
      if (el.dataset.srcUnload === '0') return;
      el.dataset.src = el.dataset.initialSrc || el.src;
      el.contentWindow.location.replace('about:blank');
    });
    parent.querySelectorAll('video').forEach(v => { if (!v.paused) v.pause(); });
    const focused = $(':focus');
    if (focused) focused.blur();
  };

  // ========================================
  // PAGE LOAD ANIMATION
  // ========================================
  const loaderTimeout = setTimeout(() => $body.classList.add('with-loader'), 500);
  const $loaderElement = document.createElement('div');
  $loaderElement.id = 'loader';
  $body.appendChild($loaderElement);

  on('load', () => {
    setTimeout(() => {
      clearTimeout(loaderTimeout);
      $body.classList.remove('is-loading');
      $body.classList.add('is-playing');
      setTimeout(() => {
        $body.classList.remove('with-loader', 'is-playing');
        $body.classList.add('is-ready');
        setTimeout(() => $body.removeChild($loaderElement), 1000);
      }, 1125);
    }, 100);
  });

  loadElements(document.body);

  // ========================================
  // SCROLL POINTS
  // ========================================
  (() => {
    const scrollPointParent = (target) => {
      const inner = $('#main > .inner');
      while (target && target.parentElement !== inner) target = target.parentElement;
      return target;
    };

    const scrollPointSpeed = (sp) => {
      const speeds = { 5: 250, 4: 500, 3: 750, 2: 1000, 1: 1250 };
      return speeds[parseInt(sp.dataset.scrollSpeed)] || 750;
    };

    const navigateScrollPoint = (event, direction) => {
      let e = scrollPointParent(event.target);
      if (!e) return;
      
      const prop = direction === 'next' ? 'nextElementSibling' : 'previousElementSibling';
      while (e && e[prop]) {
        e = e[prop];
        if (e.dataset.scrollId) {
          if (e.dataset.scrollInvisible === '1') scrollToElement(e, 'smooth', scrollPointSpeed(e));
          else location.href = '#' + e.dataset.scrollId;
          return;
        }
      }
    };

    window._nextScrollPoint = (e) => navigateScrollPoint(e, 'next');
    window._previousScrollPoint = (e) => navigateScrollPoint(e, 'previous');
    window._firstScrollPoint = (e) => { let t = scrollPointParent(e.target); while (t?.previousElementSibling) t = t.previousElementSibling; if (t?.dataset.scrollId) location.href = '#' + t.dataset.scrollId; };
    window._lastScrollPoint = (e) => { let t = scrollPointParent(e.target); while (t?.nextElementSibling) t = t.nextElementSibling; if (t?.dataset.scrollId) location.href = '#' + t.dataset.scrollId; };
    
    window._scrollToTop = () => {
      scrollToElement(null);
      if (window.location.hash) history.pushState(null, null, '.');
    };

    if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

    on('load', () => {
      const h = thisHash();
      if (h && /^[a-zA-Z0-9\-]+$/.test(h)) {
        const sp = $(`[data-scroll-id="${h}"]`);
        if (sp) scrollToElement(sp, 'instant');
      }
    });

    on('hashchange', () => {
      const h = thisHash();
      if (h && !/^[a-zA-Z0-9\-]+$/.test(h)) return false;
      const sp = $(`[data-scroll-id="${h}"]`);
      scrollToElement(sp || null, sp ? 'smooth' : 'smooth', sp ? scrollPointSpeed(sp) : 750);
      return false;
    });

    on('click', (event) => {
      let t = event.target;
      const tags = ['IMG','SVG','USE','U','STRONG','EM','CODE','S','MARK','SPAN'];
      if (tags.includes(t.tagName)) {
        while ((t = t.parentElement)) if (t.tagName === 'A') break;
        if (!t) return;
      }
      if (t.tagName === 'A' && t.getAttribute('href')?.startsWith('#')) {
        const sp = $(`[data-scroll-id="${t.hash.substring(1)}"][data-scroll-invisible="1"]`);
        if (sp) {
          event.preventDefault();
          scrollToElement(sp, 'smooth', scrollPointSpeed(sp));
        } else if (t.hash === window.location.hash) {
          event.preventDefault();
          history.replaceState(undefined, undefined, '#');
          location.replace(t.hash);
        }
      }
    });
  })();

  // ========================================
  // BROWSER HACKS
  // ========================================
  (() => {
    const style = document.createElement('style');
    style.appendChild(document.createTextNode(''));
    document.head.appendChild(style);
    const sheet = style.sheet;

    if (client.mobile) {
      if (client.flags.lsdUnits) {
        document.documentElement.style.setProperty('--viewport-height', '100svh');
        document.documentElement.style.setProperty('--background-height', '100lvh');
      } else {
        const f = () => {
          document.documentElement.style.setProperty('--viewport-height', window.innerHeight + 'px');
          document.documentElement.style.setProperty('--background-height', (window.innerHeight + 250) + 'px');
        };
        on('load', f);
        on('orientationchange', () => setTimeout(f, 100));
      }
    }

    if (client.os === 'android') {
      sheet.insertRule('body::after { }', 0);
      const rule = sheet.cssRules[0];
      const f = () => { rule.style.cssText = 'height: ' + Math.max(screen.width, screen.height) + 'px'; };
      on('load', f);
      on('orientationchange', f);
      on('touchmove', f);
      $body.classList.add('is-touch');
    } else if (client.os === 'ios') {
      if (client.osVersion <= 11) {
        sheet.insertRule('body::after { }', 0);
        sheet.cssRules[0].style.cssText = '-webkit-transform: scale(1.0)';
        sheet.insertRule('body.ios-focus-fix::before { }', 0);
        sheet.cssRules[0].style.cssText = 'height: calc(100% + 60px)';
        on('focus', () => $body.classList.add('ios-focus-fix'), true);
        on('blur', () => $body.classList.remove('ios-focus-fix'), true);
      }
      $body.classList.add('is-touch');
    }
  })();

  // ========================================
  // SCROLL EVENTS SYSTEM
  // ========================================
  const scrollEvents = {
    items: [],
    
    add(o) {
      this.items.push({
        element: o.element,
        triggerElement: o.triggerElement || o.element,
        enter: o.enter || null,
        leave: o.leave || null,
        mode: o.mode || 4,
        threshold: o.threshold || 0.25,
        offset: o.offset || 0,
        initialState: o.initialState ?? null,
        state: false
      });
    },

    handler() {
      const height = document.documentElement.clientHeight;
      const top = client.os === 'ios' ? document.body.scrollTop + window.scrollY : document.documentElement.scrollTop;
      const bottom = top + height;
      const scrollPad = client.os === 'ios' ? 125 : 0;

      scrollEvents.items.forEach(item => {
        if (!item.enter && !item.leave) return;
        if (!item.triggerElement) return;
        if (item.triggerElement.offsetParent === null) {
          if (item.state && item.leave) {
            item.state = false;
            item.leave.apply(item.element);
            if (!item.enter) item.leave = null;
          }
          return;
        }

        const bcr = item.triggerElement.getBoundingClientRect();
        const elementTop = top + Math.floor(bcr.top);
        const elementBottom = elementTop + bcr.height;
        let state;

        if (item.initialState !== null) {
          state = item.initialState;
          item.initialState = null;
        } else {
          const pad = height * item.threshold;
          const viewportTop = Math.floor(top) <= pad ? top : top + pad;
          const viewportBottom = Math.ceil(bottom) >= document.body.scrollHeight - pad ? bottom : bottom - pad;
          
          if ((viewportBottom - viewportTop) >= (elementBottom - elementTop)) {
            state = (elementTop >= viewportTop && elementBottom <= viewportBottom) ||
                    (elementTop >= viewportTop && elementTop <= viewportBottom) ||
                    (elementBottom >= viewportTop && elementBottom <= viewportBottom);
          } else {
            state = (viewportTop >= elementTop && viewportBottom <= elementBottom) ||
                    (elementTop >= viewportTop && elementTop <= viewportBottom) ||
                    (elementBottom >= viewportTop && elementBottom <= viewportBottom);
          }
        }

        if (state !== item.state) {
          item.state = state;
          if (state && item.enter) {
            item.enter.apply(item.element);
            if (!item.leave) item.enter = null;
          } else if (!state && item.leave) {
            item.leave.apply(item.element);
            if (!item.enter) item.leave = null;
          }
        }
      });
    },

    init() {
      on('load', this.handler);
      on('resize', this.handler);
      on('scroll', this.handler);
      this.handler();
    }
  };
  
  scrollEvents.init();

  // ========================================
  // DEFERRED IMAGE LOADING
  // ========================================
  (() => {
    const items = $$('.deferred');
    
    items.forEach(p => {
      const i = p.firstElementChild;
      if (!p.classList.contains('enclosed')) {
        p.style.backgroundImage = `url(${i.src})`;
        p.style.backgroundSize = '100% 100%';
        p.style.backgroundPosition = 'top left';
        p.style.backgroundRepeat = 'no-repeat';
      }
      i.style.opacity = 0;
      i.style.transitionProperty = 'opacity';
      i.style.transitionTimingFunction = 'ease-in-out';
      
      i.addEventListener('load', function() {
        if (this.dataset.src !== 'done') return;
        const duration = Date.now() - this._startLoad < 375 ? 175 : 375;
        this.style.transitionDuration = (duration / 1000) + 's';
        this.parentElement.classList.remove('loading');
        this.style.opacity = 1;
        setTimeout(() => {
          this.style.backgroundImage = 'none';
          this.style.transitionProperty = '';
          this.style.transitionTimingFunction = '';
          this.style.transitionDuration = '';
        }, duration);
      });

      scrollEvents.add({
        element: i,
        enter: function() {
          const src = this.dataset.src;
          this.dataset.src = 'done';
          this.parentElement.classList.add('loading');
          this._startLoad = Date.now();
          this.src = src;
        },
        offset: 250
      });
    });
  })();

  // ========================================
  // ON VISIBLE ANIMATIONS
  // ========================================
  const onvisible = {
    effects: {
      'blur-in': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, filter ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i) { this.style.opacity = 0; this.style.filter = `blur(${0.25 * i}rem)`; },
        play() { this.style.opacity = 1; this.style.filter = 'none'; }
      },
      'zoom-in': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, transform ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i, alt) { this.style.opacity = 0; this.style.transform = `scale(${1 - (alt ? 0.25 : 0.05) * i})`; },
        play() { this.style.opacity = 1; this.style.transform = 'none'; }
      },
      'zoom-out': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, transform ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i, alt) { this.style.opacity = 0; this.style.transform = `scale(${1 + (alt ? 0.25 : 0.05) * i})`; },
        play() { this.style.opacity = 1; this.style.transform = 'none'; }
      },
      'fade-right': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, transform ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i) { this.style.opacity = 0; this.style.transform = `translateX(${-1.5 * i}rem)`; },
        play() { this.style.opacity = 1; this.style.transform = 'none'; }
      },
      'fade-left': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, transform ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i) { this.style.opacity = 0; this.style.transform = `translateX(${1.5 * i}rem)`; },
        play() { this.style.opacity = 1; this.style.transform = 'none'; }
      },
      'fade-down': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, transform ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i) { this.style.opacity = 0; this.style.transform = `translateY(${-1.5 * i}rem)`; },
        play() { this.style.opacity = 1; this.style.transform = 'none'; }
      },
      'fade-up': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}, transform ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind(i) { this.style.opacity = 0; this.style.transform = `translateY(${1.5 * i}rem)`; },
        play() { this.style.opacity = 1; this.style.transform = 'none'; }
      },
      'fade-in': {
        type: 'transition',
        transition: (s, d) => `opacity ${s}s ease${d ? ` ${d}s` : ''}`,
        rewind() { this.style.opacity = 0; },
        play() { this.style.opacity = 1; }
      }
    },

    add(selector, settings) {
      const style = settings.style in this.effects ? settings.style : 'fade-in';
      const speed = parseInt(settings.speed || 0);
      let intensity = parseInt(settings.intensity || 5);
      const delay = parseInt(settings.delay || 0);
      const replay = settings.replay || false;
      const stagger = settings.stagger !== undefined ? (parseInt(settings.stagger) >= 0 ? parseInt(settings.stagger) : false) : false;
      const staggerSelector = settings.staggerSelector || null;
      const threshold = { 1: 0, 2: 0.125, 3: 0.25, 4: 0.375, 5: 0.475 }[parseInt(settings.threshold || 3)] || 0.25;
      const state = settings.state ?? null;
      const effect = this.effects[style];

      intensity = ((intensity / 10) * 1.75) + 0.25;

      const enter = function(children, staggerDelay = 0) {
        const _this = effect.target ? this.querySelector(effect.target) : this;
        const transitionOrig = _this.style.transition;
        _this.style.setProperty('backface-visibility', 'hidden');
        _this.style.transition = effect.transition(speed / 1000, (delay + staggerDelay) / 1000);
        effect.play.apply(_this, [intensity, !!children]);
        setTimeout(() => {
          _this.style.removeProperty('backface-visibility');
          _this.style.transition = transitionOrig;
        }, (speed + delay + staggerDelay) * 2);
      };

      const leave = function(children) {
        const _this = effect.target ? this.querySelector(effect.target) : this;
        const transitionOrig = _this.style.transition;
        _this.style.setProperty('backface-visibility', 'hidden');
        _this.style.transition = effect.transition(speed / 1000);
        effect.rewind.apply(_this, [intensity, !!children]);
        setTimeout(() => {
          _this.style.removeProperty('backface-visibility');
          _this.style.transition = transitionOrig;
        }, speed * 2);
      };

      $$(selector).forEach(e => {
        const children = (stagger !== false && staggerSelector) ? e.querySelectorAll(staggerSelector) : null;
        const targetElement = effect.target ? e.querySelector(effect.target) : e;

        if (children) {
          children.forEach(te => effect.rewind.apply(te, [intensity, true]));
        } else {
          effect.rewind.apply(targetElement, [intensity]);
        }

        let triggerElement = e;
        if (e.parentNode?.dataset.onvisibleTrigger) triggerElement = e.parentNode;
        else if (e.parentNode?.parentNode?.dataset.onvisibleTrigger) triggerElement = e.parentNode.parentNode;

        scrollEvents.add({
          element: e,
          triggerElement,
          initialState: state,
          threshold,
          enter: children ? function() {
            let staggerDelay = 0;
            children.forEach(child => {
              enter.apply(child, [children, staggerDelay]);
              staggerDelay += stagger;
            });
          } : enter,
          leave: replay ? (children ? function() {
            children.forEach(child => leave.apply(child, [children]));
          } : leave) : null
        });
      });
    }
  };

  // ========================================
  // SLIDESHOW BACKGROUND
  // ========================================
  function SlideshowBackground(id, settings) {
    if (!settings.images || !settings.target) return;

    this.id = id;
    this.wait = settings.wait || 0;
    this.defer = settings.defer || false;
    this.order = settings.order || 'default';
    this.transition = settings.transition || { style: 'crossfade', speed: 1000, delay: 6000 };
    this.images = settings.images;
    this.$target = $(settings.target);
    this.$wrapper = settings.wrapper ? $(settings.wrapper) : null;
    this.pos = 0;
    this.lastPos = 0;
    this.$slides = [];
    this.locked = false;
    this.transitionInterval = null;

    if (this.transition.delay !== false) {
      this.transition.delay = Math.max(this.transition.delay, this.transition.speed * (this.transition.style === 'crossfade' ? 2 : 3));
    }

    if (this.defer) {
      scrollEvents.add({ element: this.$target, enter: () => this.init() });
    } else {
      this.init();
    }
  }

  SlideshowBackground.prototype.init = function() {
    const _this = this;
    let loaded = 0;

    this.$target.classList.add('slideshow-background', this.transition.style);

    this.images.forEach((img, i) => {
      const $img = document.createElement('img');
      $img.src = img.src;
      $img.addEventListener('load', () => loaded++);

      const $slide = document.createElement('div');
      $slide.style.backgroundImage = `url('${img.src}')`;
      $slide.style.backgroundPosition = img.position;
      $slide.style.backgroundRepeat = 'no-repeat';
      $slide.style.backgroundSize = 'cover';
      $slide.setAttribute('role', 'img');
      $slide.setAttribute('aria-label', img.caption);
      this.$target.appendChild($slide);
      this.$slides.push($slide);
    });

    if (this.order === 'random') this.pos = Math.floor(Math.random() * this.$slides.length);
    this.lastPos = this.pos;

    const checkLoad = setInterval(() => {
      if (loaded >= this.images.length) {
        clearInterval(checkLoad);
        this.$target.classList.remove('is-loading');
        this.start();
      }
    }, 250);
  };

  SlideshowBackground.prototype.show = function(pos) {
    if (this.locked) return;
    this.lastPos = this.pos;
    this.pos = pos;

    if (this.transition.style === 'crossfade') {
      this.locked = true;
      this.$slides[this.lastPos].classList.remove('top');
      this.$slides[this.pos].classList.add('top', 'visible', 'is-playing');
      setTimeout(() => {
        this.$slides[this.lastPos].classList.remove('visible', 'initial', 'is-playing');
        this.locked = false;
      }, this.transition.speed);
    } else {
      this.$slides[this.lastPos].classList.remove('top', 'visible', 'initial', 'is-playing');
      this.$slides[this.pos].classList.add('top', 'visible', 'is-playing');
    }
  };

  SlideshowBackground.prototype.next = function() {
    let pos = this.order === 'random' 
      ? (Math.floor(Math.random() * (this.$slides.length - 1)) + this.pos + 1) % this.$slides.length
      : (this.pos + 1) % this.$slides.length;
    this.show(pos);
  };

  SlideshowBackground.prototype.start = function() {
    this.$slides[this.pos].classList.add('visible', 'top', 'initial', 'is-playing');
    if (this.$slides.length === 1 || this.transition.delay === false) return;
    setTimeout(() => {
      this.transitionInterval = setInterval(() => this.next(), this.transition.delay);
    }, this.wait);
  };

  // ========================================
  // LIGHTBOX GALLERY
  // ========================================
  function LightboxGallery() {
    this.$modal = null;
    this.$links = null;
    this.locked = false;
    this.current = null;
    this.delay = 375;
    this.navigation = true;
    this.initModal();
  }

  LightboxGallery.prototype.initModal = function() {
    const _this = this;
    let dragStart = null, dragEnd = null;

    const $modal = document.createElement('div');
    $modal.id = 'gallery-modal';
    $modal.tabIndex = -1;
    $modal.className = 'gallery-modal';
    $modal.innerHTML = '<div class="inner"><img src="" /></div><div class="caption"></div><div class="nav previous"></div><div class="nav next"></div><div class="close"></div>';
    $body.appendChild($modal);

    const $modalInner = $modal.querySelector('.inner');
    const $modalImage = $modal.querySelector('img');
    const $modalCaption = $modal.querySelector('.caption');
    const $modalNext = $modal.querySelector('.next');
    const $modalPrevious = $modal.querySelector('.previous');

    $modalImage.addEventListener('load', function() {
      this.style.setProperty('--natural-width', this.naturalWidth + 'px');
      this.style.setProperty('--natural-height', this.naturalHeight + 'px');
      $modal.classList.add('done');
      setTimeout(() => {
        if (!$modal.classList.contains('visible')) return;
        $modal.classList.add('loaded');
        setTimeout(() => $modal.classList.remove('switching', 'from-left', 'from-right', 'done'), _this.delay);
      }, $modal.classList.contains('switching') ? 0 : _this.delay);
    });

    $modal.show = function(index, offset, direction) {
      if (_this.locked) return;
      if (typeof index !== 'number') index = _this.current;
      
      if (typeof offset === 'number') {
        for (let j = 0; j < _this.$links.length; j++) {
          index = (index + offset + _this.$links.length) % _this.$links.length;
          if (index === _this.current) return;
          if (_this.$links[index].dataset.lightboxIgnore !== '1') break;
        }
      }

      const item = _this.$links[index];
      if (!item || item.dataset.lightboxIgnore === '1') return;

      _this.locked = true;

      if (_this.current !== null) {
        $modal.classList.remove('loaded');
        $modal.classList.add('switching');
        if (direction === -1) $modal.classList.add('from-left');
        if (direction === 1) $modal.classList.add('from-right');
        setTimeout(() => {
          _this.current = index;
          $modalImage.src = item.href;
          if (_this.captions) $modalCaption.innerHTML = item.querySelector('[data-caption]')?.dataset.caption || '';
          setTimeout(() => { $modal.focus(); _this.locked = false; }, _this.delay);
        }, _this.delay);
      } else {
        _this.current = index;
        $modalImage.src = item.href;
        if (_this.captions) $modalCaption.innerHTML = item.querySelector('[data-caption]')?.dataset.caption || '';
        $modal.classList.add('visible');
        setTimeout(() => { $modal.focus(); _this.locked = false; }, _this.delay);
      }
    };

    $modal.hide = function() {
      if (_this.locked || !$modal.classList.contains('visible')) return;
      _this.locked = true;
      $modal.classList.remove('visible', 'loaded', 'switching', 'from-left', 'from-right', 'done');
      setTimeout(() => {
        $modalImage.src = '';
        _this.locked = false;
        $body.focus();
        _this.current = null;
      }, _this.delay);
    };

    $modal.next = (dir) => $modal.show(null, 1, dir);
    $modal.previous = (dir) => $modal.show(null, -1, dir);

    // Touch events
    $modalInner.addEventListener('touchstart', (e) => {
      if (!_this.navigation || e.touches.length > 1) return;
      dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    });

    $modalInner.addEventListener('touchmove', (e) => {
      if (!_this.navigation || !dragStart || e.touches.length > 1) return;
      dragEnd = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      const dx = dragStart.x - dragEnd.x;
      if (Math.abs(dx) < 50) return;
      e.preventDefault();
      if (dx > 0) $modal.next(-1);
      else if (dx < 0) $modal.previous(1);
    });

    $modalInner.addEventListener('touchend', () => { dragStart = null; dragEnd = null; });

    $modal.addEventListener('click', (e) => {
      if (e.target?.tagName === 'A' || e.target?.tagName === 'SPOILER-TEXT') return;
      $modal.hide();
    });

    $modal.addEventListener('keydown', (e) => {
      if (!$modal.classList.contains('visible')) return;
      switch (e.keyCode) {
        case 39: case 32: if (_this.navigation) { e.preventDefault(); $modal.next(); } break;
        case 37: if (_this.navigation) { e.preventDefault(); $modal.previous(); } break;
        case 36: if (_this.navigation) { e.preventDefault(); $modal.show(0); } break;
        case 35: if (_this.navigation) { e.preventDefault(); $modal.show(_this.$links.length - 1); } break;
        case 27: e.preventDefault(); $modal.hide(); break;
      }
    });

    $modalNext.addEventListener('click', () => $modal.next());
    $modalPrevious.addEventListener('click', () => $modal.previous());

    this.$modal = $modal;
    this.$modalImage = $modalImage;
    this.$modalCaption = $modalCaption;
    this.$modalNext = $modalNext;
    this.$modalPrevious = $modalPrevious;
  };

  LightboxGallery.prototype.init = function(config) {
    const _this = this;
    const $links = $$(`#${config.id} .thumbnail`);
    let navigation = config.navigation;
    const validLinks = Array.from($links).filter(l => l.dataset.lightboxIgnore !== '1');
    if (validLinks.length < 2) navigation = false;

    $links.forEach((link, i) => {
      if (link.dataset.lightboxIgnore === '1') return;
      link.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        this.show(i, { $links, navigation, captions: config.captions, scheme: config.scheme });
      });
    });
  };

  LightboxGallery.prototype.show = function(href, config) {
    this.$links = config.$links;
    this.navigation = config.navigation;
    this.captions = config.captions;
    
    this.$modal.classList.remove('light', 'dark');
    if (config.scheme === 'light') this.$modal.classList.add('light');
    else if (config.scheme === 'dark') this.$modal.classList.add('dark');
    else if (config.scheme === 'auto') {
      this.$modal.classList.add(window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    }

    this.$modalNext.style.display = this.navigation ? '' : 'none';
    this.$modalPrevious.style.display = this.navigation ? '' : 'none';
    this.$modalCaption.style.display = this.captions ? '' : 'none';

    this.$modal.show(href);
  };

  const _lightboxGallery = new LightboxGallery();

  // ========================================
  // INITIALIZE COMPONENTS
  // ========================================

  // Container01 Slideshow
  (() => {
    const $target = $('#container01');
    if (!$target) return;
    
    const $slideshowBg = document.createElement('div');
    $slideshowBg.className = 'slideshow-background';
    $target.insertBefore($slideshowBg, $target.firstChild);

    new SlideshowBackground('container01', {
      target: '#container01 > .slideshow-background',
      wait: 0,
      defer: true,
      order: 'default',
      transition: { style: 'crossfade', speed: 3000, delay: 3000 },
      images: [
        { src: 'assets/images/container01-23c493b8.jpg', position: 'center', motion: 'none', speed: 2, caption: 'Untitled' },
        { src: 'assets/images/container01-0c69b518.jpg', position: 'center', motion: 'none', speed: 2, caption: 'Untitled' },
        { src: 'assets/images/container01-1e93c227.jpg', position: 'center', motion: 'none', speed: 2, caption: 'Untitled' },
        { src: 'assets/images/container01-dca7fc01.jpg', position: 'center', motion: 'none', speed: 2, caption: 'Untitled' }
      ]
    });
  })();

  // Galleries
  _lightboxGallery.init({ id: 'gallery01', navigation: true, captions: false, mobile: true, mobileNavigation: true, scheme: 'dark' });
  _lightboxGallery.init({ id: 'gallery02', navigation: true, captions: false, mobile: true, mobileNavigation: true, scheme: 'dark' });

  // On Visible Animations
  onvisible.add('.image.style1', { style: 'fade-down', speed: 1000, intensity: 0, threshold: 3, delay: 0, state: true, replay: false });
  onvisible.add('.icons.style1', { style: 'zoom-in', speed: 750, intensity: 1, threshold: 3, delay: 0, stagger: 125, staggerSelector: ':scope > li', state: true, replay: false });
  onvisible.add('.buttons.style1', { style: 'fade-left', speed: 1000, intensity: 0, threshold: 3, delay: 0, stagger: 125, staggerSelector: ':scope > li', state: true, replay: false });

  // Run ready handlers
  ready.run();

})();
